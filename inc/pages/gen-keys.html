<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>D-Crypt | Generate Keys</title>
  <link rel="stylesheet" href="../style.css">

  <!-- External Scripts -->
  <script src="../script.js" defer></script>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="container">
      <div class="logo">D-Crypt <span class="version">v1.2</span></div>
      <button id="menu-toggle" aria-label="Open menu">â˜°</button>
      <nav>
        <ul id="menu">
          <li><a href="../../index.html">Encrypt</a></li>
          <li><a href="decrypt.html">Decrypt</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="gen-keys.html" class="active">Keys generation</a></li>
          <li><a href="addContact.html">Manage contacts</a></li>
          <li><a href="duplication.html">Duplicate D-Crypt</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="content">
    <section class="generate">
      <h1>Generate New Encryption Keys</h1>

      <p>
        Open the file <code>keys.js</code> located in the <code>inc</code> folder and edit it as follows:
      </p>

      <p>
        On <strong>lines 3</strong> and <strong>4</strong>, replace the placeholders with your new <strong>private key</strong> and <strong>public key</strong>.<br><br>
        <strong>Important:</strong> Do <strong>not</strong> remove the backticks (<code>`</code>) around your keys, simply replace the red text and save the file.
      </p>

      <br>
      <p>
        If you made an error or accidentally deleted something, you can restore the entire file using the code below:
      </p>

      <div class="code-container">
        <pre class="code-block" id="codeExample">
const keys = {
  self: {
    privateKeyBase64: `<span id="privateKeyDisplay" class="red">PASTE_YOUR_PRIVATE_KEY_HERE</span>`, // Replace with your private key
    publicKeyBase64: `<span id="publicKeyDisplay" class="red">PASTE_YOUR_PUBLIC_KEY_HERE</span>` // Replace with your public key
  },
  global: {
    privateKeyBase64: `no9ewLjqJpGhx3tyNpkIWWhJ1YOu6MDYzWhe8-tg7-E`, // Do not modify this line
    publicKeyBase64: `PZ_-W-Kb2neUuzqQAMxyWuIORdJ28gjriOk5azgWj1A`, // Do not modify this line
  },
}</pre>
        <button class="copy-btn" id="copyCodeBtn">Copy code</button>
      </div>
    </section>

    <!-- GENERATED KEYS DISPLAY -->
    <section class="generated-keys">
      <div class="key-group">
        <label for="privateKey"><strong>PRIVATE KEY</strong></label>
        <textarea id="privateKey" readonly></textarea>
        <button class="copy-btn" data-copy-target="privateKey">Copy</button>
      </div>
      <br>
      <div class="key-group">
        <label for="publicKey"><strong>PUBLIC KEY</strong></label>
        <textarea id="publicKey" readonly></textarea>
        <button class="copy-btn" data-copy-target="publicKey">Copy</button>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <p>&copy; <span id="current-year"></span> D-Crypt. All rights reserved.</p>
  </footer>

  <!-- LIBSODIUM -->
  <script src="../../libsodium.js-master/dist/browsers/sodium.js" async></script>

  <!-- SCRIPT LOGIC -->
  <script>
    (function () {
      // Wait for libsodium to be ready
      function getSodium(timeoutMs = 8000) {
        return new Promise((resolve, reject) => {
          const start = Date.now();

          function checkReady(s) {
            if (s && typeof s.crypto_box_keypair === "function") {
              resolve(s);
            } else if (s && typeof s.ready?.then === "function") {
              s.ready.then(() => resolve(s)).catch(reject);
            } else {
              const poll = setInterval(() => {
                if (s && typeof s.crypto_box_keypair === "function") {
                  clearInterval(poll);
                  resolve(s);
                } else if (Date.now() - start > timeoutMs) {
                  clearInterval(poll);
                  reject(new Error("libsodium failed to initialize (timeout)."));
                }
              }, 50);
            }
          }

          if (window.sodium) {
            checkReady(window.sodium);
            return;
          }

          const pollExist = setInterval(() => {
            if (window.sodium) {
              clearInterval(pollExist);
              checkReady(window.sodium);
            } else if (Date.now() - start > timeoutMs) {
              clearInterval(pollExist);
              reject(new Error("libsodium failed to load."));
            }
          }, 50);
        });
      }

      // Copy text to clipboard by ID
      function copyToClipboardById(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const value = el.value ?? el.textContent ?? "";
        navigator.clipboard.writeText(value).then(
          () => alert("Copied to clipboard!"),
          (err) => {
            console.error("Clipboard error:", err);
            alert("Failed to copy text.");
          }
        );
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", async () => {
        const privateKeyTextarea = document.getElementById("privateKey");
        const publicKeyTextarea = document.getElementById("publicKey");
        const privateKeyDisplay = document.getElementById("privateKeyDisplay");
        const publicKeyDisplay = document.getElementById("publicKeyDisplay");

        if (!privateKeyTextarea || !publicKeyTextarea) {
          console.error("Missing textarea elements in the DOM.");
          return;
        }

        try {
          const sodium = await getSodium();

          // Generate key pair
          const keyPair = sodium.crypto_box_keypair();
          const privateKeyBase64 = sodium.to_base64(keyPair.privateKey);
          const publicKeyBase64 = sodium.to_base64(keyPair.publicKey);

          // Display in textareas
          privateKeyTextarea.value = privateKeyBase64;
          publicKeyTextarea.value = publicKeyBase64;

          // Update the example block dynamically
          if (privateKeyDisplay) privateKeyDisplay.textContent = privateKeyBase64;
          if (publicKeyDisplay) publicKeyDisplay.textContent = publicKeyBase64;

        } catch (err) {
          console.error("Key generation error:", err);
          alert("Failed to load or initialize the encryption library.");
          return;
        }

        // Copy buttons for keys
        document.querySelectorAll(".copy-btn[data-copy-target]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-copy-target");
            if (target) copyToClipboardById(target);
          });
        });

        // Copy full code example
        const copyCodeBtn = document.getElementById("copyCodeBtn");
        copyCodeBtn.addEventListener("click", () => {
          const codeBlock = document.getElementById("codeExample");
          if (!codeBlock) return;
          const text = codeBlock.innerText.trim();
          navigator.clipboard.writeText(text).then(
            () => alert("Code copied successfully!"),
            () => alert("Failed to copy code.")
          );
        });
      });
    })();
  </script>

  <style>
    .code-container {
      position: relative;
    }

    #copyCodeBtn {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 12px;
      background: #fff;
      color: #000;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #copyCodeBtn:hover {
      background: #f38470;
      color: #fbedde;
    }
  </style>
</body>
</html>